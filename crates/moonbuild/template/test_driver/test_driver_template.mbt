// Generated by moon test.

type Moonbit_Test_Driver_Internal_No_Args_Map = @moonbitlang/core/prelude.Map[
  String,
  @moonbitlang/core/prelude.Map[
    Int,
    (() -> Unit raise, @moonbitlang/core/prelude.Array[String]),
  ],
]

type Moonbit_Test_Driver_Internal_TestDriver_With_Args_Map = @moonbitlang/core/prelude.Map[
  String,
  @moonbitlang/core/prelude.Map[
    Int,
    (
      (Moonbit_Test_Driver_Internal_Test_Arg) -> Unit raise,
      @moonbitlang/core/prelude.Array[String],
    ),
  ],
]

type Moonbit_Test_Driver_Internal_TestDriver_Async_Map = @moonbitlang/core/prelude.Map[
  String,
  @moonbitlang/core/prelude.Map[
    Int,
    (
      async () -> Unit raise,
      @moonbitlang/core/prelude.Array[String],
    ),
  ],
]

type Moonbit_Test_Driver_Internal_TestDriver_Async_With_Args_Map = @moonbitlang/core/prelude.Map[
  String,
  @moonbitlang/core/prelude.Map[
    Int,
    (
      async (Moonbit_Test_Driver_Internal_Test_Arg) -> Unit raise,
      @moonbitlang/core/prelude.Array[String],
    ),
  ],
]

let moonbit_test_driver_internal_no_args_tests : Moonbit_Test_Driver_Internal_No_Args_Map = { }  // WILL BE REPLACED
let moonbit_test_driver_internal_with_args_tests : Moonbit_Test_Driver_Internal_TestDriver_With_Args_Map = { }  // WILL BE REPLACED
let moonbit_test_driver_internal_async_tests : Moonbit_Test_Driver_Internal_TestDriver_Async_Map = { }  // WILL BE REPLACED
let moonbit_test_driver_internal_async_tests_with_args : Moonbit_Test_Driver_Internal_TestDriver_Async_With_Args_Map = { }  // WILL BE REPLACED

///|
pub fn moonbit_test_driver_internal_do_execute(
  async_tests : Array[async () -> Unit],
  filename : String,
  index : Int,
) -> Unit {
  fn handle_result(
    testname : String,
    message : String,
    skipped : Bool,
  ) {
    // In WASM, this function is called by the external test driver, but here
    // in native mode there's nothing that calls it, so we call it manually.
    if not(skipped) && MOONBIT_TEST_DRIVER_INTERNAL_IS_NATIVE {
      // {COVERAGE_END}
    }
    let file_name = filename.escape()
    let test_name = testname.escape()
    let message = message.escape()
    @moonbitlang/core/prelude.println("{BEGIN_MOONTEST}")
    @moonbitlang/core/prelude.println(
      "{\"package\": \"{PACKAGE}\", \"filename\": \{file_name}, \"index\": \"\{index}\", \"test_name\": \{test_name}, \"message\": \{message}}",
    )
    @moonbitlang/core/prelude.println("{END_MOONTEST}")
  }

  fn test_should_be_skipped(name : String, attrs : Array[String]) -> Bool {
    guard MOONBIT_TEST_DRIVER_INTERNAL_IS_NATIVE else { false }
    for attr in attrs {
      if attr is [.."panic", ..] {
        @moonbitlang/core/prelude.println("skipped test block: \{filename}: \{name}")
        handle_result(name, "skipped test", true)
        return true
      }
    } else {
      false
    }
  }

  fn on_err(name : String, err : Error) {
    match err {
      @moonbitlang/core/prelude.Failure::Failure(e)
      | @moonbitlang/core/prelude.InspectError::InspectError(e)
      | @moonbitlang/core/prelude.SnapshotError::SnapshotError(e)
      | MoonBitTestDriverInternalJsError(e) => {
        handle_result(name, e, false)
      }
      e => {
        let message = moonbit_test_driver_internal_error_to_string(e)
        handle_result(name, message, false)
      }
    }
  }

  if (
    moonbit_test_driver_internal_no_args_tests.get(filename) is Some(index_map) &&
    index_map.get(index) is Some((f, attrs))
  ) {
    let name = if attrs is [name, ..] { name } else { "" }
    guard !test_should_be_skipped(name, attrs) else { return }
    moonbit_test_driver_internal_catch_error(
      f,
      on_ok=() => handle_result(name, "", false),
      on_err=(err) => on_err(name, err),
    )
    return
  }

  if (
    moonbit_test_driver_internal_with_args_tests.get(filename) is Some(index_map) &&
    index_map.get(index) is Some((f, attrs))
  ) {
    let name = if attrs is [name, ..] { name } else { "" }
    guard !test_should_be_skipped(name, attrs) else {}
    moonbit_test_driver_internal_catch_error(
      () => f(moonbit_test_driver_internal_new_test_arg(name)),
      on_ok=() => handle_result(name, "", false),
      on_err=err => on_err(name, err),
    )
    return
  }

  if (
    moonbit_test_driver_internal_async_tests.get(filename) is Some(index_map) &&
    index_map.get(index) is Some((f, attrs))
  ) {
    let name = if attrs is [name, ..] { name } else { "" }
    guard !test_should_be_skipped(name, attrs) else {}
    async_tests.push(() => {
      try f() catch {
        err if moonbit_test_driver_internal_is_being_cancelled() => raise err
        err => on_err(name, err)
      } noraise {
        _ => handle_result(name, "", false)
      }
    })
    return
  }

  if (
    moonbit_test_driver_internal_async_tests_with_args.get(filename) is Some(index_map) &&
    index_map.get(index) is Some((f, attrs))
  ) {
    let name = if attrs is [name, ..] { name } else { "" }
    guard !test_should_be_skipped(name, attrs) else {}
    async_tests.push(() => {
      try f(moonbit_test_driver_internal_new_test_arg(name)) catch {
        err if moonbit_test_driver_internal_is_being_cancelled() => raise err
        err => on_err(name, err)
      } noraise {
        _ => handle_result(name, "", false)
      }
    })
    return
  }

  handle_result("", "skipped test", true)
}

///|
let moonbit_test_driver_internal_max_concurrent_tests : Int = 10

#cfg(target="native")
#test_entry
fn main {
  let async_tests = []
  for arg in moonbit_test_driver_internal_native_parse_args() {
    moonbit_test_driver_internal_do_execute(async_tests, arg.0, arg.1)
  }
  moonbit_test_driver_internal_run_async_tests(async_tests)
}

#cfg(not(target="native"))
#test_entry
fn main {
  ()
}

#cfg(target="js")
pub fn moonbit_test_driver_internal_execute(
  tests : Array[MoonBitTestDriverInternalTestEntry],
) -> Unit {
  let async_tests = []
  for i in 0..<tests.length() {
    let entry = tests[i]
    moonbit_test_driver_internal_do_execute(async_tests, entry.filename(), entry.index())
  }
  moonbit_test_driver_internal_run_async_tests(async_tests)
}

#cfg(any(target="wasm", target="wasm-gc"))
pub fn moonbit_test_driver_internal_execute(
  filename : MoonbitTestDriverInternalExternString,
  index : Int,
) -> Unit {
  let filename = moonbit_test_driver_internal_get_file_name(filename)
  let async_tests = []
  moonbit_test_driver_internal_do_execute(async_tests, filename, index)
  moonbit_test_driver_internal_run_async_tests(async_tests)
}

#cfg(not(target="native"))
pub fn moonbit_test_driver_finish() -> Unit {
  // {COVERAGE_END}
}
