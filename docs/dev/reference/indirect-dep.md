# Indirect Dependency Resolution

## Overview

The MoonBit build system generates an `all_pkgs.json` file for each build target to facilitate indirect dependency resolution. This metadata file is created during build operations (such as `check`, `build`, `run`, `test`, `info`, and `bundle`) and is placed in the corresponding target directory (e.g., `target/wasm-gc/release/build/all_pkgs.json`).

The `all_pkgs.json` file contains a subset of the information found in the full `packages.json` file, specifically focused on package artifacts and their locations. While `moon.pkg.json` only specifies direct dependencies of a package, `all_pkgs.json` provides the compiler (`moonc`) with the complete picture of all available packages, including indirect dependencies. This enables the compiler to resolve and import packages that are not directly listed in a package's dependency configuration but are transitively required through the dependency chain.

## File Structure

The `all_pkgs.json` file contains an array of package entries, where each entry includes:

- **root**: The module name (e.g., `moonbitlang/core`)
- **rel**: The package path relative to the module (e.g., `list`)
- **artifact**: The absolute file system path to the package's `.mi` (interface) file

Example structure:

```json
{
  "packages": [
    {
      "root": "moonbitlang/core",
      "rel": "builtin",
      "artifact": "/path/to/target/wasm-gc/release/build/moonbitlang/core/builtin/builtin.mi"
    },
    {
      "root": "username/mymodule",
      "rel": "utils",
      "artifact": "/path/to/target/wasm-gc/release/build/username/mymodule/utils/utils.mi"
    }
  ]
}
```

## Use Case

When compiling a package, the compiler needs to know the locations of all available package interfaces, not just the direct dependencies. For example, if package A depends on package B, and package B depends on package C, then package A may need to resolve types or interfaces from package C even though C is not listed in A's `moon.pkg.json`. The `all_pkgs.json` file provides this transitive dependency information to the compiler.

The file path to `all_pkgs.json` is passed to the compiler via the `--all_pkgs` option for both `moonc build-package` and `moonc check` commands, allowing the compiler to resolve indirect dependencies during compilation and type checking.

## Generation

The file is generated by the `gen_all_pkgs_json` function in `crates/moonbuild-rupes-recta/src/all_pkgs.rs`, which iterates through all resolved packages and collects their artifact paths according to the target backend and build configuration.
